import { NextRequest, NextResponse } from "next/server";
import OpenAI from "openai";

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

export async function POST(request: NextRequest) {
  try {
    let imageBase64;
    try {
      const body = await request.json();
      imageBase64 = body.imageBase64;
    } catch (parseError) {
      return NextResponse.json(
        { error: "ìš”ì²­ ë³¸ë¬¸ì„ íŒŒì‹±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤." },
        { status: 400 }
      );
    }

    if (!imageBase64) {
      return NextResponse.json(
        { error: "ì´ë¯¸ì§€ê°€ ì œê³µë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤." },
        { status: 400 }
      );
    }

    if (!process.env.OPENAI_API_KEY) {
      return NextResponse.json(
        { error: "OpenAI API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤." },
        { status: 500 }
      );
    }

    // GPT-4o Vision APIë¥¼ ì‚¬ìš©í•˜ì—¬ ì´ë¯¸ì§€ ë¶„ì„
    const response = await openai.chat.completions.create({
      model: "gpt-4o",
      messages: [
        {
          role: "system",
          content: `ë‹¹ì‹ ì€ ê·¼ë¬´í‘œ ì´ë¯¸ì§€ë¥¼ ë¶„ì„í•˜ëŠ” ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ìº˜ë¦°ë” ì´ë¯¸ì§€ì—ì„œ ë‚ ì§œì™€ í•´ë‹¹ ë‚ ì§œ ì¹¸ì˜ ë°°ê²½ìƒ‰ì„ ì •í™•íˆ ë¶„ì„í•˜ì—¬ JSON í˜•ì‹ìœ¼ë¡œ ë°˜í™˜í•´ì£¼ì„¸ìš”.

## âš ï¸ ì ˆëŒ€ì  ìƒ‰ìƒ íŒë³„ ê¸°ì¤€ (ë°˜ë“œì‹œ ì¤€ìˆ˜ - ì´ê²ƒì´ ìµœìš°ì„ ì…ë‹ˆë‹¤!)

### ğŸ”µ ê·¼ë¬´ (íŒŒë€ìƒ‰/í•˜ëŠ˜ìƒ‰ ê³„ì—´) - ë¬´ì¡°ê±´ "ê·¼ë¬´"
**ê¸°ì¤€ ìƒ‰ìƒ ì½”ë“œ:**
- #0082EB (RGB: 0, 130, 235) - ì§„í•œ íŒŒë€ìƒ‰
- #57BBE7 (RGB: 87, 187, 231) - í•˜ëŠ˜ìƒ‰/ë°ì€ íŒŒë€ìƒ‰

ë‹¤ìŒ ìƒ‰ìƒ ê³„ì—´ì€ **ë¬´ì¡°ê±´ "ê·¼ë¬´"**ë¡œ ë¶„ë¥˜í•˜ì„¸ìš”:
- ìœ„ ê¸°ì¤€ ìƒ‰ìƒê³¼ ìœ ì‚¬í•œ ëª¨ë“  íŒŒë€ìƒ‰ ê³„ì—´ (#0082EB, #57BBE7ì™€ ë¹„ìŠ·í•œ ìƒ‰ìƒ)
- í•˜ëŠ˜ìƒ‰(Sky Blue): RGBì—ì„œ B ê°’ì´ ë†’ê³  R, G ê°’ì´ ì¤‘ê°„ì¸ ë°ì€ íŒŒë€ìƒ‰
- íŒŒë€ìƒ‰(Blue): RGBì—ì„œ B ê°’ì´ R, G ê°’ë³´ë‹¤ í›¨ì”¬ ë†’ì€ ìƒ‰ìƒ
- ì²­ë¡ìƒ‰(Cyan): RGBì—ì„œ B ê°’ì´ ë†’ê³  G ê°’ë„ ë†’ì§€ë§Œ, Bê°€ Gë³´ë‹¤ ë†’ì€ ìƒ‰ìƒ
- **ì¤‘ìš”**: #0082EB, #57BBE7ì™€ ìœ ì‚¬í•œ ëª¨ë“  íŒŒë€ìƒ‰/í•˜ëŠ˜ìƒ‰ ê³„ì—´ì€ ë¬´ì¡°ê±´ ê·¼ë¬´

### ğŸŸ¢ íœ´ë¬´ (ì—°ë‘ìƒ‰/ì˜¬ë¦¬ë¸Œ ê·¸ë¦° ê³„ì—´) - ë¬´ì¡°ê±´ "íœ´ë¬´"
**ê¸°ì¤€ ìƒ‰ìƒ ì½”ë“œ:**
- #B0BF08 (RGB: 176, 191, 8) - ì˜¬ë¦¬ë¸Œ ê·¸ë¦°/ì—°ë‘ìƒ‰

ë‹¤ìŒ ìƒ‰ìƒ ê³„ì—´ì€ **ë¬´ì¡°ê±´ "íœ´ë¬´"**ë¡œ ë¶„ë¥˜í•˜ì„¸ìš”:
- ìœ„ ê¸°ì¤€ ìƒ‰ìƒê³¼ ìœ ì‚¬í•œ ëª¨ë“  ì´ˆë¡ìƒ‰ ê³„ì—´ (#B0BF08ì™€ ë¹„ìŠ·í•œ ìƒ‰ìƒ)
- ì—°ë‘ìƒ‰(Lime): RGBì—ì„œ G(ì´ˆë¡ìƒ‰) ê°’ì´ ë†’ê³  R ê°’ë„ ë†’ì€ ë°ì€ ì´ˆë¡ìƒ‰ ê³„ì—´
- ì˜¬ë¦¬ë¸Œ ê·¸ë¦°(Olive Green): RGBì—ì„œ G ê°’ì´ ë†’ê³  R ê°’ë„ ì¤‘ê°„ì¸ ë…¸ë€ìƒ‰ì´ ì„ì¸ ì´ˆë¡ìƒ‰
- Yellow-Green, Chartreuse ë“± **ëª¨ë“  ì´ˆë¡ìƒ‰ ê³„ì—´**
- **ì¤‘ìš”**: #B0BF08ì™€ ìœ ì‚¬í•œ ëª¨ë“  ì—°ë‘ìƒ‰/ì˜¬ë¦¬ë¸Œ ê·¸ë¦° ê³„ì—´ì€ ë¬´ì¡°ê±´ íœ´ë¬´

## Step-by-Step ë¶„ì„ í”„ë¡œì„¸ìŠ¤

ê° ë‚ ì§œë¥¼ ë¶„ì„í•  ë•Œ ë°˜ë“œì‹œ ë‹¤ìŒ ìˆœì„œë¡œ ì§„í–‰í•˜ì„¸ìš”:

### Step 1: ë²”ë¡€(Legend) í™•ì¸ (ìµœìš°ì„ )
1. ì´ë¯¸ì§€ì˜ êµ¬ì„(ë³´í†µ ìƒë‹¨, í•˜ë‹¨, ì¢Œì¸¡, ìš°ì¸¡)ì— ë²”ë¡€ê°€ ìˆëŠ”ì§€ í™•ì¸
2. ë²”ë¡€ê°€ ìˆë‹¤ë©´:
   - ë²”ë¡€ì—ì„œ "íœ´ë¬´" ë˜ëŠ” "ê·¼ë¬´"ì— í•´ë‹¹í•˜ëŠ” ìƒ‰ìƒì„ ë¨¼ì € í™•ì¸
   - ë²”ë¡€ì˜ ìƒ‰ìƒì´ ìµœìš°ì„  ê¸°ì¤€ì…ë‹ˆë‹¤
   - ë²”ë¡€ì˜ ìƒ‰ìƒì„ RGB í†¤ìœ¼ë¡œ ì •í™•íˆ íŒŒì•…

### Step 2: RGB ìƒ‰ìƒ í†¤ ë¶„ì„ (ê°€ì¥ ì¤‘ìš”!)
ê° ë‚ ì§œ ì…€ì„ ë¶„ì„í•  ë•Œ:
1. **ë°°ê²½ìƒ‰ì˜ RGB í†¤ì„ ë¨¼ì € ë¶„ì„ (ì´ê²ƒì´ ìµœìš°ì„ !)**
   - R(ë¹¨ê°•), G(ì´ˆë¡), B(íŒŒë‘) ê°’ì˜ ìƒëŒ€ì  ë¹„ìœ¨ì„ ì •í™•íˆ íŒŒì•…
   - **G ê°’ì´ R, Bë³´ë‹¤ ë†’ìœ¼ë©´ â†’ ì´ˆë¡ìƒ‰ ê³„ì—´ â†’ ë¬´ì¡°ê±´ íœ´ë¬´**
   - **B ê°’ì´ R, Gë³´ë‹¤ ë†’ìœ¼ë©´ â†’ íŒŒë€ìƒ‰ ê³„ì—´ â†’ ë¬´ì¡°ê±´ ê·¼ë¬´**
   - **ì¤‘ìš”**: Gì™€ Bê°€ ë¹„ìŠ·í•˜ë”ë¼ë„, Bê°€ ì¡°ê¸ˆì´ë¼ë„ ë†’ìœ¼ë©´ íŒŒë€ìƒ‰ ê³„ì—´(ê·¼ë¬´), Gê°€ ì¡°ê¸ˆì´ë¼ë„ ë†’ìœ¼ë©´ ì´ˆë¡ìƒ‰ ê³„ì—´(íœ´ë¬´)
   - R, G, Bê°€ ë¹„ìŠ·í•˜ë©´ â†’ íšŒìƒ‰/í°ìƒ‰ ê³„ì—´ â†’ Step 3ìœ¼ë¡œ

2. **ìƒ‰ìƒ íŒë³„ ì˜ˆì‹œ (ë°˜ë“œì‹œ ì´ë ‡ê²Œ íŒë‹¨í•˜ì„¸ìš”):**
   - #0082EB (RGB: 0, 130, 235) â†’ B(235)ê°€ ê°€ì¥ ë†’ìŒ â†’ íŒŒë€ìƒ‰ ê³„ì—´ â†’ **ê·¼ë¬´**
   - #57BBE7 (RGB: 87, 187, 231) â†’ B(231)ê°€ ê°€ì¥ ë†’ìŒ â†’ í•˜ëŠ˜ìƒ‰ ê³„ì—´ â†’ **ê·¼ë¬´**
   - #B0BF08 (RGB: 176, 191, 8) â†’ G(191)ê°€ ê°€ì¥ ë†’ìŒ â†’ ì˜¬ë¦¬ë¸Œ ê·¸ë¦° ê³„ì—´ â†’ **íœ´ë¬´**
   - RGB(100, 200, 250) â†’ B(250)ê°€ ê°€ì¥ ë†’ìŒ â†’ íŒŒë€ìƒ‰ ê³„ì—´ â†’ **ê·¼ë¬´**
   - RGB(150, 220, 100) â†’ G(220)ê°€ ê°€ì¥ ë†’ìŒ â†’ ì´ˆë¡ìƒ‰ ê³„ì—´ â†’ **íœ´ë¬´**
   - RGB(200, 200, 200) â†’ ë¹„ìŠ·í•¨ â†’ íšŒìƒ‰ ê³„ì—´ â†’ Step 3ìœ¼ë¡œ
   
3. **ê¸°ì¤€ ìƒ‰ìƒê³¼ì˜ ìœ ì‚¬ë„ íŒë‹¨:**
   - #0082EB, #57BBE7ì™€ ë¹„ìŠ·í•œ ìƒ‰ìƒ(íŒŒë€ìƒ‰ ê³„ì—´) â†’ **ê·¼ë¬´**
   - #B0BF08ì™€ ë¹„ìŠ·í•œ ìƒ‰ìƒ(ì—°ë‘ìƒ‰/ì˜¬ë¦¬ë¸Œ ê·¸ë¦° ê³„ì—´) â†’ **íœ´ë¬´**

### Step 3: ìƒ‰ìƒì´ ì• ë§¤í•œ ê²½ìš° ë³´ì¡° íŒë‹¨
ë°°ê²½ìƒ‰ì´ ëª…í™•í•˜ì§€ ì•Šê±°ë‚˜ íšŒìƒ‰/í°ìƒ‰ ê³„ì—´ì¸ ê²½ìš°:

1. **í…ìŠ¤íŠ¸(ê¸€ì) ìƒ‰ìƒ í™•ì¸**
   - ë‚ ì§œ ìˆ«ìë‚˜ í…ìŠ¤íŠ¸ì˜ ìƒ‰ìƒì„ í™•ì¸
   - í…ìŠ¤íŠ¸ê°€ íŒŒë€ìƒ‰ ê³„ì—´ì´ë©´ â†’ ê·¼ë¬´
   - í…ìŠ¤íŠ¸ê°€ ì´ˆë¡ìƒ‰ ê³„ì—´ì´ë©´ â†’ íœ´ë¬´

2. **ì£¼ë³€ ì…€ê³¼ì˜ ëª…ì•” ì°¨ì´ ë¹„êµ**
   - ì£¼ë³€ ì…€(ìœ„, ì•„ë˜, ì¢Œ, ìš°)ì˜ ìƒ‰ìƒê³¼ ë¹„êµ
   - í•´ë‹¹ ì…€ì´ ì£¼ë³€ë³´ë‹¤ íŒŒë€ìƒ‰ í†¤ì´ ê°•í•˜ë©´ â†’ ê·¼ë¬´
   - í•´ë‹¹ ì…€ì´ ì£¼ë³€ë³´ë‹¤ ì´ˆë¡ìƒ‰ í†¤ì´ ê°•í•˜ë©´ â†’ íœ´ë¬´
   - ëª…ì•” ì°¨ì´ë¥¼ í†µí•´ ë¯¸ì„¸í•œ ìƒ‰ìƒ ì°¨ì´ë¥¼ ê°ì§€

3. **í…ìŠ¤íŠ¸ ë‚´ìš© ì°¸ê³  (ìµœí›„ì˜ ìˆ˜ë‹¨)**
   - ìƒ‰ìƒ íŒë³„ì´ ë§¤ìš° ì• ë§¤í•œ ê²½ìš°ì—ë§Œ í…ìŠ¤íŠ¸ ë‚´ìš© ì°¸ê³ 
   - "OFF", "íœ´", "ATDO", "ADO" â†’ íœ´ë¬´
   - "KE"ë¡œ ì‹œì‘, ë¹„í–‰ ê´€ë ¨ í…ìŠ¤íŠ¸ â†’ ê·¼ë¬´

### Step 4: Reasoning ê¸°ë¡
ê° ë‚ ì§œì— ëŒ€í•´ ë‹¤ìŒì„ reasoning í•„ë“œì— ê¸°ë¡:
- RGB í†¤ ë¶„ì„ ê²°ê³¼ (ì˜ˆ: "RGB í†¤ ë¶„ì„: Bê°’ì´ ë†’ì•„ íŒŒë€ìƒ‰ ê³„ì—´ë¡œ íŒë‹¨")
- ë²”ë¡€ ì°¸ê³  ì—¬ë¶€ (ì˜ˆ: "ë²”ë¡€ì—ì„œ íŒŒë€ìƒ‰ì´ ê·¼ë¬´ë¡œ í‘œì‹œë¨")
- ë³´ì¡° íŒë‹¨ ì‚¬ìš© ì—¬ë¶€ (ì˜ˆ: "ë°°ê²½ìƒ‰ì´ ì• ë§¤í•˜ì—¬ í…ìŠ¤íŠ¸ ìƒ‰ìƒ(íŒŒë€ìƒ‰)ìœ¼ë¡œ íŒë‹¨")
- ìµœì¢… íŒë‹¨ ê·¼ê±°

## ë°˜í™˜ í˜•ì‹

ë‹¤ìŒê³¼ ê°™ì€ JSON ë°°ì—´ í˜•ì‹ìœ¼ë¡œ ë°˜í™˜í•˜ì„¸ìš”:
[
  {
    "date": "2026-01-01",
    "color": "#B0BF08 ë˜ëŠ” ìœ ì‚¬í•œ ì—°ë‘ìƒ‰",
    "type": "íœ´ë¬´",
    "reasoning": "Step 2: RGB í†¤ ë¶„ì„ - ë°°ê²½ìƒ‰ì´ #B0BF08(ì˜¬ë¦¬ë¸Œ ê·¸ë¦°)ì™€ ìœ ì‚¬, RGB(176, 191, 8), Gê°’(191)ì´ ê°€ì¥ ë†’ì•„ ì´ˆë¡ìƒ‰ ê³„ì—´ë¡œ íŒë‹¨. ê¸°ì¤€ ìƒ‰ìƒ #B0BF08ì™€ ì¼ì¹˜. ìµœì¢…: íœ´ë¬´"
  },
  {
    "date": "2026-01-02",
    "color": "#0082EB ë˜ëŠ” ìœ ì‚¬í•œ íŒŒë€ìƒ‰",
    "type": "ê·¼ë¬´",
    "reasoning": "Step 2: RGB í†¤ ë¶„ì„ - ë°°ê²½ìƒ‰ì´ #0082EB(ì§„í•œ íŒŒë€ìƒ‰)ì™€ ìœ ì‚¬, RGB(0, 130, 235), Bê°’(235)ì´ ê°€ì¥ ë†’ì•„ íŒŒë€ìƒ‰ ê³„ì—´ë¡œ íŒë‹¨. ê¸°ì¤€ ìƒ‰ìƒ #0082EBì™€ ì¼ì¹˜. ìµœì¢…: ê·¼ë¬´"
  },
  {
    "date": "2026-01-03",
    "color": "#57BBE7 ë˜ëŠ” ìœ ì‚¬í•œ í•˜ëŠ˜ìƒ‰",
    "type": "ê·¼ë¬´",
    "reasoning": "Step 2: RGB í†¤ ë¶„ì„ - ë°°ê²½ìƒ‰ì´ #57BBE7(í•˜ëŠ˜ìƒ‰)ì™€ ìœ ì‚¬, RGB(87, 187, 231), Bê°’(231)ì´ ê°€ì¥ ë†’ì•„ íŒŒë€ìƒ‰ ê³„ì—´ë¡œ íŒë‹¨. ê¸°ì¤€ ìƒ‰ìƒ #57BBE7ì™€ ì¼ì¹˜. ìµœì¢…: ê·¼ë¬´"
  }
]

## âš ï¸ ì¤‘ìš” ì‚¬í•­ (ë°˜ë“œì‹œ ì¤€ìˆ˜!)

1. **ê¸°ì¤€ ìƒ‰ìƒ ì½”ë“œë¥¼ ìš°ì„  ì°¸ê³ í•˜ì„¸ìš”!**
   - **ê·¼ë¬´**: #0082EB (ì§„í•œ íŒŒë€ìƒ‰), #57BBE7 (í•˜ëŠ˜ìƒ‰)ì™€ ìœ ì‚¬í•œ ìƒ‰ìƒ
   - **íœ´ë¬´**: #B0BF08 (ì˜¬ë¦¬ë¸Œ ê·¸ë¦°/ì—°ë‘ìƒ‰)ì™€ ìœ ì‚¬í•œ ìƒ‰ìƒ
2. **ìƒ‰ìƒ ê¸°ë°˜ íŒë‹¨ì´ ìµœìš°ì„ ì…ë‹ˆë‹¤!** ê¸°ì¤€ ìƒ‰ìƒê³¼ ìœ ì‚¬í•œ ìƒ‰ìƒì€ í•´ë‹¹ ì¹´í…Œê³ ë¦¬ë¡œ ë¶„ë¥˜
3. **RGB í†¤ì„ ë¨¼ì € ë¶„ì„í•œ í›„ íŒë‹¨í•˜ì„¸ìš”** (ë°”ë¡œ JSON ë§Œë“¤ì§€ ë§ ê²ƒ)
4. **íŒŒë€ìƒ‰ê³¼ ì´ˆë¡ìƒ‰ì„ ì ˆëŒ€ í˜¼ë™í•˜ì§€ ë§ˆì„¸ìš”** 
   - #0082EB, #57BBE7ì™€ ìœ ì‚¬í•œ ìƒ‰ìƒ(íŒŒë€ìƒ‰ ê³„ì—´) â†’ **ê·¼ë¬´**
   - #B0BF08ì™€ ìœ ì‚¬í•œ ìƒ‰ìƒ(ì—°ë‘ìƒ‰/ì˜¬ë¦¬ë¸Œ ê·¸ë¦° ê³„ì—´) â†’ **íœ´ë¬´**
5. **reasoning í•„ë“œì— ê¸°ì¤€ ìƒ‰ìƒ ì½”ë“œì™€ì˜ ë¹„êµ ê²°ê³¼ë¥¼ ë°˜ë“œì‹œ í¬í•¨í•˜ì„¸ìš”**
6. **ìƒ‰ìƒì´ ì• ë§¤í•˜ë©´ Step 3ì˜ ë³´ì¡° íŒë‹¨ì„ ì‚¬ìš©í•˜ì„¸ìš”**
7. ë‚ ì§œëŠ” 2026ë…„ ê¸°ì¤€ìœ¼ë¡œ íŒŒì‹±í•˜ì„¸ìš”
8. JSONë§Œ ë°˜í™˜í•˜ê³  ë‹¤ë¥¸ ì„¤ëª…ì€ í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”`,
        },
        {
          role: "user",
          content: [
            {
              type: "image_url",
              image_url: {
                url: `data:image/jpeg;base64,${imageBase64}`,
                detail: "high",
              },
            },
          ],
        },
      ],
      max_tokens: 4000,
    });

    const content = response.choices[0]?.message?.content;
    if (!content) {
      return NextResponse.json(
        { error: "ì´ë¯¸ì§€ ë¶„ì„ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤." },
        { status: 500 }
      );
    }

    // JSON ì¶”ì¶œ (ë§ˆí¬ë‹¤ìš´ ì½”ë“œ ë¸”ë¡ ì œê±°)
    let jsonString = content.trim();
    if (jsonString.startsWith("```json")) {
      jsonString = jsonString.replace(/```json\n?/g, "").replace(/```\n?/g, "");
    } else if (jsonString.startsWith("```")) {
      jsonString = jsonString.replace(/```\n?/g, "");
    }

    // JSON íŒŒì‹±
    let scheduleData;
    try {
      scheduleData = JSON.parse(jsonString);
    } catch (parseError) {
      // JSON íŒŒì‹± ì‹¤íŒ¨ ì‹œ, JSON ë¶€ë¶„ë§Œ ì¶”ì¶œ ì‹œë„
      const jsonMatch = jsonString.match(/\[[\s\S]*\]/);
      if (jsonMatch) {
        scheduleData = JSON.parse(jsonMatch[0]);
      } else {
        throw new Error("JSON í˜•ì‹ìœ¼ë¡œ íŒŒì‹±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      }
    }

    // ë°ì´í„° ìœ íš¨ì„± ê²€ì‚¬ ë° ì •ê·œí™”
    if (!Array.isArray(scheduleData)) {
      throw new Error("ì¼ì • ë°ì´í„°ê°€ ë°°ì—´ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.");
    }

    // ë‚ ì§œ í˜•ì‹ ê²€ì¦ ë° ì •ê·œí™”
    const normalizedSchedule = scheduleData
      .map((item: any) => {
        if (!item.date) {
          return null;
        }

        // ë‚ ì§œ íŒŒì‹± (YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ ì •ê·œí™”)
        let dateStr = item.date;
        if (typeof dateStr === "string") {
          // ë‹¤ì–‘í•œ ë‚ ì§œ í˜•ì‹ ì§€ì›
          const dateMatch = dateStr.match(/(\d{4})[-\/](\d{1,2})[-\/](\d{1,2})/);
          if (dateMatch) {
            const [, year, month, day] = dateMatch;
            dateStr = `${year}-${month.padStart(2, "0")}-${day.padStart(2, "0")}`;
          }
        }

        // ìƒ‰ìƒ ê¸°ë°˜ íƒ€ì… ê²°ì • (ìµœìš°ì„ )
        let workType = "";
        const color = (item.color || "").toLowerCase();
        const type = item.type || "";
        const reasoning = item.reasoning || "";

        // ìƒ‰ìƒ ê¸°ë°˜ íŒë‹¨ (ìµœìš°ì„ ) - ê¸°ì¤€ ìƒ‰ìƒ ì½”ë“œ ê¸°ë°˜ íŒë‹¨
        // ê¸°ì¤€ ìƒ‰ìƒ: #0082EB, #57BBE7 (ê·¼ë¬´), #B0BF08 (íœ´ë¬´)
        
        // ì—°ë‘ìƒ‰/ì˜¬ë¦¬ë¸Œ ê·¸ë¦° ê³„ì—´ (#B0BF08ì™€ ìœ ì‚¬) - ë¬´ì¡°ê±´ íœ´ë¬´
        const greenKeywords = [
          "ì—°ë‘", "lime", "yellow-green", "light green", "chartreuse", 
          "ì´ˆë¡", "green", "grass", "emerald", "mint", "olive",
          "verdant", "leaf", "forest", "jade", "teal-green",
          "#b0bf08", "#B0BF08", "b0bf08" // ê¸°ì¤€ ìƒ‰ìƒ ì½”ë“œ
        ];
        const isGreen = greenKeywords.some(keyword => color.includes(keyword));

        // íŒŒë€ìƒ‰/í•˜ëŠ˜ìƒ‰ ê³„ì—´ (#0082EB, #57BBE7ì™€ ìœ ì‚¬) - ë¬´ì¡°ê±´ ê·¼ë¬´
        const blueKeywords = [
          "íŒŒë€", "í•˜ëŠ˜", "blue", "cyan", "sky", "azure", "navy",
          "light blue", "steel blue", "royal blue", "powder blue",
          "cornflower", "turquoise", "aqua", "cerulean", "sapphire",
          "#0082eb", "#0082EB", "0082eb", // ê¸°ì¤€ ìƒ‰ìƒ ì½”ë“œ
          "#57bbe7", "#57BBE7", "57bbe7"  // ê¸°ì¤€ ìƒ‰ìƒ ì½”ë“œ
        ];
        const isBlue = blueKeywords.some(keyword => color.includes(keyword));

        // ìƒ‰ìƒ ê¸°ë°˜ íŒë‹¨ì´ ìµœìš°ì„ 
        if (isGreen) {
          workType = "íœ´ë¬´";
        } else if (isBlue) {
          workType = "ê·¼ë¬´";
        } 
        // ìƒ‰ìƒ íŒë‹¨ì´ ì•ˆ ë˜ë©´ type í•„ë“œ ì‚¬ìš©
        else if (type && (type === "íœ´ë¬´" || type === "ê·¼ë¬´")) {
          workType = type;
        }
        // ëª¨ë‘ ì‹¤íŒ¨í•˜ë©´ ê¸°íƒ€
        else {
          workType = "ê¸°íƒ€";
        }

        return {
          date: dateStr,
          text: workType, // ìµœì¢… ê²°ì •ëœ ê·¼ë¬´ ìœ í˜•
          originalColor: item.color || "",
          reasoning: reasoning, // íŒë‹¨ ê·¼ê±°
        };
      })
      .filter((item: any) => item !== null);

    return NextResponse.json(
      { schedule: normalizedSchedule, raw: true }, // raw í”Œë˜ê·¸ ì¶”ê°€
      {
        status: 200,
        headers: {
          "Content-Type": "application/json",
        },
      }
    );
  } catch (error: any) {
    console.error("ì´ë¯¸ì§€ ë¶„ì„ ì˜¤ë¥˜:", error);
    
    // OpenAI API ì—ëŸ¬ ì²˜ë¦¬
    if (error instanceof Error) {
      if (error.message.includes("API key")) {
        return NextResponse.json(
          { error: "OpenAI API í‚¤ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. .env.local íŒŒì¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”." },
          {
            status: 401,
            headers: {
              "Content-Type": "application/json",
            },
          }
        );
      }
    }

    return NextResponse.json(
      {
        error: error.message || "ì´ë¯¸ì§€ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.",
        details: process.env.NODE_ENV === "development" ? error.stack : undefined,
      },
      {
        status: 500,
        headers: {
          "Content-Type": "application/json",
        },
      }
    );
  }
}
